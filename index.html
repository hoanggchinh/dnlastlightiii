<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TomTitmuiii</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">


<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    :root {
        --bg-peal: rgba(255, 255, 255, 0.1); /* non-blurred fallback */
        --dock-bg: rgba(20, 20, 20, 0.3);
        --menu-bg: rgba(20, 20, 20, 0.3);
        --window-bg: rgba(30, 30, 32, 0.85);
        --window-header: #2d2d2d;
        --text-color: #ffffff;
        --accent: #007aff;
        --system-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * { box-sizing: border-box; user-select: none; }
    body, html {
        margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden;
        font-family: var(--system-font); color: var(--text-color);
        /* Default Wallpaper - Monterey style */
        background: linear-gradient(200deg, #a729f5, #5823d6, #092775, #1d6f9c);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        cursor: default;
    }

    @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    /* --- Boot Screen --- */
    #boot-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 99999;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        transition: opacity 1s ease-out;
    }
    .apple-logo { color: white; font-size: 80px; margin-bottom: 40px; }
    .loading-bar {
        width: 200px; height: 6px; background: #333; border-radius: 3px; overflow: hidden;
    }
    .loading-progress {
        height: 100%; background: #fff; width: 0%; border-radius: 3px;
        transition: width 3s ease-in-out;
    }

    /* --- UI Layout --- */
    #desktop { width: 100%; height: 100%; position: relative; }

    /* Menu Bar */
    #menubar {
        position: absolute; top: 0; width: 100%; height: 30px;
        background: var(--menu-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 20px; font-size: 13px; font-weight: 500; z-index: 5000;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .menu-left, .menu-right { display: flex; gap: 15px; align-items: center; }
    .menu-item:hover { background: rgba(255,255,255,0.1); border-radius: 4px; padding: 2px 8px; margin: -2px -8px;}
    .apple-icon { font-size: 16px; }
    #active-app-name { font-weight: 700; }

    /* Dock */
#dock-container {
    position: absolute;
    bottom: 6px; /* giảm khoảng cách so với mép dưới */
    width: 100%;
    display: flex;
    justify-content: center;
    z-index: 6000;
}

#dock {
    background: var(--dock-bg);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    border: 1px solid rgba(255,255,255,0.1);
    height: 55px;           /* ↓ từ 70px xuống 55px */
    padding: 4px 8px;       /* ↓ từ 5px 10px xuống 4px 8px */
    border-radius: 16px;    /* bo góc nhẹ hơn */
    display: flex;
    align-items: flex-end;
    gap: 8px;
    box-shadow: 0 8px 15px rgba(0,0,0,0.3);
    transition: all 0.2s ease;
}

.dock-item {
    width: 45px;            /* ↓ từ 55px */
    height: 45px;           /* ↓ từ 55px */
    border-radius: 10px;    /* tỉ lệ nhỏ hơn phù hợp */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.2s cubic-bezier(0.25, 1, 0.5, 1);
    position: relative;
    cursor: pointer;
}

/* SVG Icon Styles */
.dock-icon-svg {
    width: 100%;
    height: 100%;
    border-radius: 10px; /* khớp với kích thước mới */
}

.dock-item:hover {
    transform: scale(1.2) translateY(-8px); /* hover nhẹ hơn */
    margin: 0 4px;
}

.dock-dot {
    width: 5px;
    height: 5px;
    background: rgba(255,255,255,0.4);
    border-radius: 50%;
    position: absolute;
    bottom: -6px; /* nâng dot lên cho cân đối */
    display: none;
}

.dock-item.active .dock-dot {
    display: block;
}

    /* Bounce Animation */
    @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-20px); }
    }
    .bouncing { animation: bounce 0.6s ease infinite; }

    /* --- Windows System --- */
    .window {
        position: absolute; background: var(--window-bg);
        backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.15);
        box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        display: flex; flex-direction: column; overflow: hidden;
        min-width: 300px; min-height: 200px;
        transition: transform 0.15s, opacity 0.15s, box-shadow 0.2s;
        transform-origin: center;
    }

    /* Window opening animation */
    .window.opening { animation: winOpen 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes winOpen { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; }}

    /* Inactive window state */
    .window.inactive {
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        border-color: rgba(255,255,255,0.05);
    }
    .window.inactive .traffic-lights span { background-color: #555 !important; color: #555 !important;}

    .window-header {
        height: 30px; background: rgba(255,255,255,0.05);
        display: flex; align-items: center; position: relative; cursor: grab;
    }
    .window-header:active { cursor: grabbing; }

    .traffic-lights {
        display: flex; gap: 8px; margin-left: 12px; z-index: 2;
    }
    .t-btn {
        width: 12px; height: 12px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
        font-size: 8px; color: transparent; transition: 0.1s; cursor: default;
    }
    .traffic-lights:hover .t-btn { color: rgba(0,0,0,0.6); }
    .close-btn { background: #ff5f56; }
    .min-btn { background: #ffbd2e; }
    .max-btn { background: #27c93f; }

    .window-title {
        position: absolute; width: 100%; text-align: center; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.8); pointer-events: none;
    }
    .window-content {
        flex: 1; overflow: auto; position: relative;
        user-select: text; /* Allow text selection inside apps */
    }

    /* jQuery UI Resizable Handle Fix */
    .ui-resizable-se { bottom: 0; right: 0; width: 15px; height: 15px; background: none; }

    /* --- Context Menu --- */
    #context-menu {
        position: absolute; background: rgba(40,40,40,0.9); backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 5px 0;
        width: 180px; display: none; z-index: 99999;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .ctx-item { padding: 6px 15px; font-size: 13px; cursor: default; display: flex; justify-content: space-between;}
    .ctx-item:hover { background: var(--accent); color: white; }
    .ctx-hr { border-top: 1px solid rgba(255,255,255,0.1); margin: 4px 0; }


    /* Apple Menu Items */
    .apple-menu-item {
        padding: 7px 15px;
        font-size: 13px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background 0.15s;
    }
    .apple-menu-item:hover {
        background: var(--accent);
        color: white;
    }
    .apple-menu-item i {
        color: inherit;
    }
    /* --- APP SPECIFIC STYLES --- */

    /* Finder */
    .finder-layout { display: flex; height: 100%; background: #1e1e1e; color: #ddd; }
    .finder-sidebar { width: 140px; background: rgba(50,50,50,0.3); padding: 10px; backdrop-filter: blur(10px); display: flex; flex-direction: column; gap: 5px;}
    .sidebar-item { padding: 5px 10px; border-radius: 5px; font-size: 12px; display: flex; align-items: center; gap: 8px; cursor: pointer;}
    .sidebar-item:hover { background: rgba(255,255,255,0.1); }
    .sidebar-item i { color: var(--accent); width: 15px; text-align: center;}
    .finder-main { flex: 1; padding: 10px; overflow-y: auto; }
    .finder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
    .file-item { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; }
    .file-icon { font-size: 40px; color: #5dade2; margin-bottom: 5px; }
    .file-icon.folder { color: #5dade2; }
    .file-icon.text { color: #ddd; }
    .file-icon.img { color: #58d68d; }
    .file-name { font-size: 12px; word-break: break-all; padding: 2px 4px; border-radius: 3px;}
    .file-item:hover .file-name { background: var(--accent); }

    /* TextEdit */
    .textedit-app { background: #2d2d2d; height: 100%; display: flex; flex-direction: column; }
    .text-toolbar { padding: 5px; background: #3a3a3a; border-bottom: 1px solid #444; display: flex; gap: 5px; }
    .text-tool { padding: 4px 8px; background: #444; border-radius: 4px; cursor: pointer; font-size: 12px;}
    #text-area { flex: 1; background: #1e1e1e; color: #eee; border: none; padding: 15px; font-family: var(--system-font); font-size: 14px; outline: none; resize: none; line-height: 1.5; }

    /* Sketch (Paint) */
    .paint-app { display: flex; flex-direction: column; height: 100%; background: #fff; }
    .paint-toolbar { padding: 8px; background: #f0f0f0; border-bottom: 1px solid #ccc; display: flex; gap: 10px; align-items: center; color: #333;}
    #paint-canvas { background: white; cursor: crosshair; touch-action: none; flex: 1; display: block;}

    /* Calculator */
    .calc-app { background: #333; height: 100%; display: flex; flex-direction: column; padding: 10px; }
    #calc-display { background: transparent; color: white; font-size: 36px; text-align: right; border: none; width: 100%; margin-bottom: 10px; outline: none; font-weight: 300;}
    .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; flex: 1; }
    .calc-btn { border: none; border-radius: 50%; font-size: 18px; cursor: pointer; transition: filter 0.1s; color: white;}
    .calc-btn:active { filter: brightness(1.2); }
    .c-num { background: #555; }
    .c-op { background: #ff9f0a; font-size: 22px; padding-top: 3px;}
    .c-top { background: #a5a5a5; color: black; }
    .c-zero { grid-column: span 2; border-radius: 30px; text-align: left; padding-left: 25px;}

    /* Safari */
    .safari-app { display: flex; flex-direction: column; height: 100%; background: #fff; }
    .safari-bar { padding: 8px; background: #f0f0f0; border-bottom: 1px solid #ccc; display: flex; gap: 10px; align-items: center; }
    .url-bar { flex: 1; background: #ddd; border: none; padding: 5px 10px; border-radius: 8px; text-align: center; font-size: 12px; color: #333; outline: none;}
    .safari-frame { flex: 1; border: none; width: 100%; background: white; }

    /* Studio (Video) */
    .studio-app { background: #000; height: 100%; display: flex; flex-direction: column; }
    .video-stage { flex: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative;}
    #main-video { max-width: 100%; max-height: 100%; }
    .studio-controls { height: 80px; background: #1a1a1a; padding: 10px; display: flex; flex-direction: column; gap: 5px; }
    .filters-row { display: flex; gap: 10px; justify-content: center; }
    .filter-btn { padding: 4px 10px; background: #333; border-radius: 4px; font-size: 11px; cursor: pointer; border: 1px solid #444;}
    .filter-btn.active { background: var(--accent); border-color: var(--accent); }
    .playback-row { display: flex; justify-content: center; align-items: center; gap: 15px; color: #ddd;}

    /* Settings */
    .settings-app { padding: 20px; color: white; display: flex; flex-direction: column; gap: 20px; align-items: center;}
    .wall-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; }
    .wall-thumb { height: 80px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: 0.2s;}
    .wall-thumb:hover { transform: scale(1.02); }
    .wall-thumb.selected { border-color: var(--accent); }

    /* SVGs for Icons (Data URIs for single file) */
    /* Using generated geometric gradients to look like modern macOS icons */
    .icon-finder { background: linear-gradient(180deg, #e3e3e3 0%, #c7c7c7 100%); position: relative; overflow: hidden; }
    .icon-finder::after { content: ':)'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(90deg); font-size: 30px; font-weight: bold; color: #2a62b3; font-family: monospace;}

    .icon-safari { background: white; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23fff'/%3E%3Ccircle cx='50' cy='50' r='45' fill='%231facfd'/%3E%3Cpath d='M50 5 L50 95 M5 50 L95 50' stroke='rgba(255,255,255,0.3)' stroke-width='1'/%3E%3Cpolygon points='50,10 60,45 90,50 55,60 50,90 40,55 10,50 45,40' fill='white'/%3E%3Cpolygon points='50,10 55,45 50,50 45,45' fill='%23ea4335'/%3E%3C/svg%3E"); background-size: cover;}

    .icon-terminal { background: #222; position: relative; }
    .icon-terminal::after { content: '>_'; color: #fff; position: absolute; top: 10px; left: 10px; font-family: monospace; font-size: 24px; font-weight: bold;}

    .icon-text { background: linear-gradient(180deg, #fdfdfd 0%, #dcdcdc 100%); position: relative; }
    .icon-text::after { content: ''; position: absolute; top: 15px; left: 10px; right: 10px; height: 2px; background: #999; box-shadow: 0 5px 0 #999, 0 10px 0 #999, 0 15px 0 #999; }

    .icon-paint { background: linear-gradient(45deg, #ff3b30, #ff9500, #ffcc00, #4cd964, #5ac8fa, #007aff, #5856d6, #ff2d55); }
    .icon-paint::after { content: '\f1fc'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 30px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-shadow: 0 2px 5px rgba(0,0,0,0.3);}

    .icon-calc { background: #333; display: grid; grid-template-columns: 1fr 1fr; padding: 5px; gap: 2px;}
    .icon-calc div { background: #ff9f0a; border-radius: 4px; }
    .icon-calc div:nth-child(1), .icon-calc div:nth-child(2) { background: #555; }

    .icon-studio { background: linear-gradient(135deg, #3a1c71, #d76d77, #ffaf7b); position: relative; }
    .icon-studio::after { content: '\f008'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: white; font-size: 28px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

    .icon-settings { background: linear-gradient(180deg, #8e8e93 0%, #636366 100%); position: relative; }
    .icon-settings::after { content: '\f013'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #ddd; font-size: 35px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

    .icon-trash { background: linear-gradient(180deg, #f2f2f7 0%, #d1d1d6 100%); position: relative; }
    .icon-trash::after { content: '\f1f8'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #777; font-size: 30px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }




    /* --- CSS CHO AUTH (Login/Register) --- */
    .auth-container {
        padding: 20px;
        color: #333;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .auth-box {
        background: #fff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .auth-input {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .auth-btn {
        width: 100%;
        padding: 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .auth-btn:hover { background: #0056b3; }
    .auth-link {
        text-align: center;
        font-size: 0.9em;
        color: #007bff;
        cursor: pointer;
        margin-top: 10px;
        display: block;
    }
    .hidden { display: none; }



</style>
</head>
<body>

    <div id="boot-screen">
        <i class="fab fa-apple apple-logo"></i>
        <div class="loading-bar"><div class="loading-progress"></div></div>
    </div>

    <div id="desktop">

        <div id="menubar">
            <div class="menu-left">
                <div class="menu-item apple-menu-trigger" style="cursor:pointer; position:relative;">
                    <i class="fab fa-apple apple-icon"></i>
                </div>
                <div class="menu-item" id="active-app-name">Finder</div>
                <div class="menu-item">File</div>
                <div class="menu-item">Edit</div>
                <div class="menu-item">View</div>
                <div class="menu-item">Go</div>
                <div class="menu-item">Window</div>
                <div class="menu-item">Help</div>
            </div>
            <div class="menu-right">
                <div class="menu-item"><i class="fas fa-battery-three-quarters"></i> <span id="battery-level">84%</span></div>
                <div class="menu-item"><i class="fas fa-wifi"></i></div>
                <div class="menu-item"><i class="fas fa-search"></i></div>
                <div class="menu-item"><i class="fas fa-sliders-h"></i></div>
                <div class="menu-item" id="clock">Tue Jan 9 9:41 AM</div>
            </div>
        </div>

        <!-- Apple Menu Dropdown -->
        <div id="apple-menu" style="
            position: absolute;
            top: 30px;
            left: 10px;
            background: rgba(40,40,40,0.95);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 5px 0;
            width: 220px;
            display: none;
            z-index: 9999;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        ">

            <!-- Hiển thị khi chưa đăng nhập -->
            <div id="menu-guest">
                <div class="apple-menu-item" id="menu-login-btn">
                    <i class="fas fa-user-circle" style="width:18px;"></i>
                    <span>Login / Register</span>
                </div>
            </div>

            <!-- Hiển thị khi đã đăng nhập -->
            <div id="menu-logged" style="display:none;">
                <div style="padding:8px 15px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:12px; color:#aaa;">
                    <div style="font-weight:600; color:#fff; font-size:13px;" id="menu-user-email">user@example.com</div>
                    <div>Logged In</div>
                </div>
                <div class="apple-menu-item" id="menu-logout-btn">
                    <i class="fas fa-sign-out-alt" style="width:18px;"></i>
                    <span>Logout</span>
                </div>
            </div>

            <div class="ctx-hr"></div>
            <div class="apple-menu-item" id="menu-settings-btn">
                <i class="fas fa-cog" style="width:18px;"></i>
                <span>System Settings...</span>
            </div>
        </div>






        <div id="windows-container"></div>

        <div id="context-menu">
            <div class="ctx-item" onclick="wm.openApp('finder')">New Folder</div>
            <div class="ctx-hr"></div>
            <div class="ctx-item">Get Info</div>
            <div class="ctx-item" onclick="wm.openApp('settings')">Change Wallpaper...</div>
            <div class="ctx-hr"></div>
            <div class="ctx-item">Sort By</div>
        </div>

        <div id="dock-container">
            <div id="dock">
                </div>
        </div>
    </div>

<script>
    // --- System Config & State ---
    const apps = [
        { id: 'finder', name: 'Finder', iconClass: 'icon-finder' },
        { id: 'safari', name: 'Safari', iconClass: 'icon-safari' },
        { id: 'chatbot', name: 'Chatbot', iconClass: 'icon-terminal' },
        { id: 'login', name: 'Account', iconClass: 'icon-text' },
        { id: 'paint', name: 'Sketch', iconClass: 'icon-paint' },
        { id: 'calculator', name: 'Calculator', iconClass: 'icon-calc', htmlIcon: '<div></div><div></div><div></div><div></div>' },
        { id: 'studio', name: 'Studio', iconClass: 'icon-studio' },
        { id: 'settings', name: 'Settings', iconClass: 'icon-settings' },
        { id: 'trash', name: 'Bin', iconClass: 'icon-trash', separator: true }
    ];

    // Simulated File System
    const fileSystem = {
        'Desktop': { type: 'folder', children: {
            'Welcome.txt': { type: 'text', content: 'Welcome to macOS Web Edition!\nThis is a simulation built in a single HTML file.'},
            'Project': { type: 'folder', children: {} }
        }},
        'Documents': { type: 'folder', children: {
            'notes.txt': { type: 'text', content: 'Buy milk\nFinish code'}
        }},
        'Downloads': { type: 'folder', children: {
            'image.jpg': { type: 'img', src: ''}
        }}
    };
    let currentPath = ['Desktop'];

    // --- Window Manager Class ---
    class WindowManager {
        constructor() {
            this.windows = {};
            this.zIndexCounter = 100;
            this.activeApp = 'Finder';
            this.initDock();
            this.setupDesktop();
        }

        initDock() {
            const dock = $('#dock');
            apps.forEach(app => {
                if(app.separator) dock.append('<div style="width:1px; height:40px; background:rgba(255,255,255,0.2); margin: 0 5px;"></div>');

                let iconHtml = app.htmlIcon ? app.htmlIcon : '';
                let el = $(`
                    <div class="dock-item" id="dock-${app.id}" title="${app.name}">
                        <div class="dock-icon-svg ${app.iconClass}">${iconHtml}</div>
                        <div class="dock-dot"></div>
                    </div>
                `);
                el.on('click', () => this.openApp(app.id));
                dock.append(el);
            });
        }

        setupDesktop() {
            // Context Menu
            $(document).on('contextmenu', '#desktop', (e) => {
                if ($(e.target).closest('.window').length === 0 && $(e.target).closest('#dock').length === 0 && $(e.target).closest('#menubar').length === 0) {
                    e.preventDefault();
                    $('#context-menu').css({top: e.clientY, left: e.clientX}).fadeIn(100);
                }
            });
            $(document).on('click', () => $('#context-menu').fadeOut(100));
        }

        updateMenubar(appName) {
            this.activeApp = appName;
            $('#active-app-name').text(appName);
        }

        setActiveWindow(id) {
            $('.window').addClass('inactive');
            $(`#win-${id}`).removeClass('inactive').css('z-index', ++this.zIndexCounter);
            this.updateMenubar(this.windows[id].name);
        }

        openApp(appId) {
            const appConfig = apps.find(a => a.id === appId);

            // Bounce animation
            const dockItem = $(`#dock-${appId}`);
            if(!dockItem.hasClass('active') && !dockItem.hasClass('bouncing')) {
                dockItem.addClass('bouncing');
                setTimeout(() => dockItem.removeClass('bouncing').addClass('active'), 600);
            }

            // Check if already open
            if (this.windows[appId]) {
                if($(`#win-${appId}`).is(':hidden')) {
                    this.restoreWindow(appId);
                } else {
                    this.setActiveWindow(appId);
                }
                return;
            }

            this.createWindow(appId, appConfig);
        }

        createWindow(id, config) {
            this.windows[id] = config;

            // Default dimensions based on app type
            let w = 600, h = 400;
            if(id === 'calculator') { w = 250; h = 350; }
            if(id === 'paint' || id === 'studio') { w = 700; h = 500; }
            if(id === 'settings') { w = 500; h = 300; }
            // Đặt kích thước mặc định cho Chatbot
            if(id === 'chatbot') { w = 900; h = 600; }
            // Random position placement
            const top = 50 + (Object.keys(this.windows).length * 20);
            const left = 50 + (Object.keys(this.windows).length * 20);

            const winHTML = `
                <div class="window opening" id="win-${id}" style="width:${w}px; height:${h}px; top:${top}px; left:${left}px; z-index:${++this.zIndexCounter}">
                    <div class="window-header">
                        <div class="traffic-lights">
                            <div class="t-btn close-btn"><i class="fas fa-times"></i></div>
                            <div class="t-btn min-btn"><i class="fas fa-minus"></i></div>
                            <div class="t-btn max-btn"><i class="fas fa-plus"></i></div>
                        </div>
                        <div class="window-title">${config.name}</div>
                    </div>
                    <div class="window-content" id="content-${id}"></div>
                </div>
            `;

            $('#windows-container').append(winHTML);
            const $win = $(`#win-${id}`);

            // Make interactive
            $win.draggable({ handle: '.window-header', containment: '#desktop', start: () => this.setActiveWindow(id) })
                .resizable({ minHeight: 200, minWidth: 250, stop: ()=> { if(id==='paint') resizeCanvas(); }})
                .on('mousedown', () => this.setActiveWindow(id));

            // Window button events
            $win.find('.close-btn').on('click', (e) => { e.stopPropagation(); this.closeWindow(id); });
            $win.find('.min-btn').on('click', (e) => { e.stopPropagation(); this.minimizeWindow(id); });
            $win.find('.max-btn').on('click', (e) => { e.stopPropagation(); this.maximizeWindow(id); });

            // Remove opening class after animation
            setTimeout(() => $win.removeClass('opening'), 200);

            this.setActiveWindow(id);
            this.loadAppContent(id, $win); // Truyền $win vào để JS có thể tìm đúng phần tử
        }

        closeWindow(id) {
            $(`#win-${id}`).fadeOut(150, function() { $(this).remove(); });
            delete this.windows[id];
            $(`#dock-${id}`).removeClass('active');
            this.updateMenubar('Finder');
        }

        minimizeWindow(id) {
            // Simple fade out for simulate minimize to dock
            $(`#win-${id}`).fadeOut(200);
            this.updateMenubar('Finder');
        }

        restoreWindow(id) {
            $(`#win-${id}`).fadeIn(200);
            this.setActiveWindow(id);
        }

        maximizeWindow(id) {
            const $win = $(`#win-${id}`);
            if ($win.hasClass('maximized')) {
                $win.css({ top: $win.data('top'), left: $win.data('left'), width: $win.data('width'), height: $win.data('height') }).removeClass('maximized');
            } else {
                $win.data({ top: $win.css('top'), left: $win.css('left'), width: $win.css('width'), height: $win.css('height') });
                $win.css({ top: '30px', left: '0', width: '100%', height: 'calc(100% - 100px)' }).addClass('maximized');
            }
            if(id==='paint') setTimeout(resizeCanvas, 200);
        }

        loadAppContent(id, $win) { // $win là cửa sổ jQuery (ví dụ: $('#win-terminal'))
            const container = $(`#content-${id}`);
            switch(id) {
                case 'finder': renderFinder(container); break;
                case 'chatbot': renderTerminal(container, id, $win); break;
                case 'login': renderTextEdit(container, id, $win); break;
                case 'paint': renderPaint(container); break;
                case 'calculator': renderCalculator(container); break;
                case 'safari': renderSafari(container); break;
                case 'studio': renderStudio(container); break;
                case 'settings': renderSettings(container); break;
                case 'trash': container.html('<div style="padding:20px; text-align:center; color:#aaa;">Trash is empty.<br><i class="fas fa-trash fa-3x" style="margin-top:20px;"></i></div>'); break;
            }
        }
    }

    const wm = new WindowManager();

    // --- App Implementations ---

    // 1. FINDER
    function renderFinder(container) {
        container.html(`
            <div class="finder-layout">
                <div class="finder-sidebar">
                    <div style="font-size:10px; color:#888; padding-left:10px; margin-top:10px;">Favorites</div>
                    <div class="sidebar-item" onclick="navFinder(['Desktop'])"><i class="fas fa-desktop"></i> Desktop</div>
                    <div class="sidebar-item" onclick="navFinder(['Documents'])"><i class="fas fa-file-alt"></i> Documents</div>
                    <div class="sidebar-item" onclick="navFinder(['Downloads'])"><i class="fas fa-download"></i> Downloads</div>
                </div>
                <div class="finder-main">
                    <div style="margin-bottom:10px; color:#888; font-size:12px;"><i class="fas fa-chevron-left"></i> <i class="fas fa-chevron-right"></i> &nbsp; ${currentPath.join(' > ')}</div>
                    <div class="finder-grid" id="finder-grid"></div>
                </div>
            </div>
        `);
        updateFinderGrid();
    }

    window.navFinder = function(path) {
        currentPath = path;
        renderFinder($('#content-finder'));
    }

    function updateFinderGrid() {
        const grid = $('#finder-grid');
        grid.empty();

        let target = fileSystem;
        currentPath.forEach(p => target = target[p] ? target[p].children : target);

        if(!target) return;

        Object.keys(target).forEach(key => {
            const item = target[key];
            let icon = 'fa-folder folder';
            if(item.type === 'text') icon = 'fa-file-alt text';
            if(item.type === 'img') icon = 'fa-file-image img';

            const el = $(`
                <div class="file-item">
                    <i class="fas ${icon} file-icon"></i>
                    <div class="file-name">${key}</div>
                </div>
            `);

            el.on('dblclick', () => {
                if(item.type === 'folder') {
                    currentPath.push(key);
                    renderFinder($('#content-finder'));
                } else if (item.type === 'text') {
                    wm.openApp('textedit');
                    setTimeout(() => $('#text-area').val(item.content), 200);
                }
            });
            grid.append(el);
        });
    }

    // 2. TERMINAL (CHATBOT ĐÃ GỘP)
function renderTerminal(container, id, $win) {
    const uniqueId = $win.attr('id');

    // --- 1. KHAI BÁO BIẾN TRẠNG THÁI ---
    // Lấy ID người dùng từ LocalStorage (được lưu lúc đăng nhập ở app Tài Khoản)
    let currentUserId = localStorage.getItem('userId');
    let currentChatId = null; // null nghĩa là đang ở trạng thái tạo đoạn chat mới

    // --- 2. CSS FULL (GIAO DIỆN MACOS DARK MODE) ---
    const chatStyles = `
        <style>
            .macos-chat-${uniqueId} {
                display: flex;
                height: 100%;
                background: #171717;
                color: #e5e5e5;
                font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
                user-select: text;
                overflow: hidden; /* Tránh vỡ layout */
            }

            /* --- SIDEBAR --- */
            .macos-chat-${uniqueId} .chat-sidebar {
                width: 240px;
                background: #000000;
                border-right: 1px solid #262626;
                display: flex;
                flex-direction: column;
                flex-shrink: 0;
            }

            .macos-chat-${uniqueId} .sidebar-header {
                padding: 16px;
                border-bottom: 1px solid #262626;
            }

            .macos-chat-${uniqueId} .new-chat-btn {
                width: 100%;
                padding: 10px 12px;
                background: #262626;
                border: 1px solid #333;
                border-radius: 8px;
                color: #e5e5e5;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all 0.2s;
            }

            .macos-chat-${uniqueId} .new-chat-btn:hover {
                background: #333;
                border-color: #444;
            }

            .macos-chat-${uniqueId} .chat-history {
                flex: 1;
                overflow-y: auto;
                padding: 10px;
            }

            /* Scrollbar cho sidebar */
            .macos-chat-${uniqueId} .chat-history::-webkit-scrollbar { width: 6px; }
            .macos-chat-${uniqueId} .chat-history::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

            .macos-chat-${uniqueId} .history-item {
                padding: 10px;
                border-radius: 6px;
                font-size: 13px;
                cursor: pointer;
                margin-bottom: 4px;
                transition: background 0.2s;
                display: flex;
                align-items: flex-start;
                gap: 10px;
                color: #a1a1aa;
            }

            .macos-chat-${uniqueId} .history-item:hover {
                background: rgba(255,255,255,0.08);
                color: #e5e5e5;
            }

            .macos-chat-${uniqueId} .history-item.active {
                background: #262626;
                color: #fff;
            }

            .macos-chat-${uniqueId} .history-title {
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                font-weight: 500;
            }

            .macos-chat-${uniqueId} .history-time {
                font-size: 11px;
                color: #555;
                margin-top: 2px;
            }

            .macos-chat-${uniqueId} .loading-msg {
                text-align: center; font-size: 12px; color: #666; padding: 20px 0;
            }

            /* --- MAIN CHAT AREA --- */
            .macos-chat-${uniqueId} .chat-main {
                flex: 1;
                display: flex;
                flex-direction: column;
                background: #171717;
                position: relative;
            }

            .macos-chat-${uniqueId} .chat-header {
                height: 60px;
                background: rgba(23, 23, 23, 0.95);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid #262626;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 24px;
                flex-shrink: 0;
                z-index: 10;
            }

            .macos-chat-${uniqueId} .header-left {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .macos-chat-${uniqueId} .bot-avatar-header {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                font-size: 14px;
                color: white;
                box-shadow: 0 2px 10px rgba(0, 122, 255, 0.3);
            }

            .macos-chat-${uniqueId} .bot-info h3 { margin: 0; font-size: 15px; font-weight: 600; color: #fff; }
            .macos-chat-${uniqueId} .bot-info p { margin: 2px 0 0 0; font-size: 12px; color: #34c759; display: flex; align-items: center; gap: 4px; }
            .macos-chat-${uniqueId} .bot-info p::before { content: ''; width: 6px; height: 6px; background: #34c759; border-radius: 50%; display: inline-block; }

            /* --- MESSAGES CONTAINER --- */
            .macos-chat-${uniqueId} .messages-container {
                flex: 1;
                overflow-y: auto;
                padding: 24px;
                display: flex;
                flex-direction: column;
                gap: 20px;
                scroll-behavior: smooth;
            }
            .macos-chat-${uniqueId} .messages-container::-webkit-scrollbar { width: 8px; }
            .macos-chat-${uniqueId} .messages-container::-webkit-scrollbar-track { background: transparent; }
            .macos-chat-${uniqueId} .messages-container::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

            .macos-chat-${uniqueId} .message-wrapper {
                display: flex;
                gap: 14px;
                max-width: 85%;
                animation: fadeIn 0.3s ease;
            }
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

            .macos-chat-${uniqueId} .message-wrapper.user {
                flex-direction: row-reverse;
                align-self: flex-end;
            }

            .macos-chat-${uniqueId} .message-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                flex-shrink: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: 600;
                color: white;
            }

            .macos-chat-${uniqueId} .message-avatar.bot { background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%); }
            .macos-chat-${uniqueId} .message-avatar.user { background: linear-gradient(135deg, #FF9500 0%, #FF2D55 100%); }

            .macos-chat-${uniqueId} .message-content {
                display: flex;
                flex-direction: column;
                gap: 4px;
                min-width: 0;
            }
            .macos-chat-${uniqueId} .message-wrapper.user .message-content { align-items: flex-end; }

            .macos-chat-${uniqueId} .message-bubble {
                padding: 12px 18px;
                border-radius: 18px;
                font-size: 14px;
                line-height: 1.5;
                position: relative;
                word-wrap: break-word;
            }

            .macos-chat-${uniqueId} .message-bubble.bot {
                background: #2c2c2e;
                color: #e5e5e5;
                border-top-left-radius: 4px;
            }

            .macos-chat-${uniqueId} .message-bubble.user {
                background: #0A84FF;
                color: white;
                border-top-right-radius: 4px;
            }

            .macos-chat-${uniqueId} .message-time { font-size: 11px; color: #666; margin: 0 4px; }


            .macos-chat-${uniqueId} .typing-indicator {
                display: flex; gap: 4px; padding: 10px 14px; background: #2c2c2e; border-radius: 18px; border-top-left-radius: 4px; width: fit-content;
            }
            .macos-chat-${uniqueId} .typing-dot {
                width: 6px; height: 6px; border-radius: 50%; background: #888; animation: bounce 1.4s infinite ease-in-out both;
            }
            .macos-chat-${uniqueId} .typing-dot:nth-child(1) { animation-delay: -0.32s; }
            .macos-chat-${uniqueId} .typing-dot:nth-child(2) { animation-delay: -0.16s; }
            @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

            /* --- INPUT AREA --- */
            .macos-chat-${uniqueId} .input-container {
                background: #171717;
                border-top: 1px solid #262626;
                padding: 20px;
                flex-shrink: 0;
            }

            .macos-chat-${uniqueId} .input-wrapper {
                display: flex;
                gap: 12px;
                align-items: flex-end;
                background: #262626;
                border: 1px solid #333;
                border-radius: 24px;
                padding: 8px 8px 8px 16px;
                transition: border-color 0.2s;
            }
            .macos-chat-${uniqueId} .input-wrapper:focus-within { border-color: #555; }

            .macos-chat-${uniqueId} .chat-input {
                flex: 1;
                background: transparent;
                border: none;
                color: #fff;
                font-size: 14px;
                resize: none;
                outline: none;
                max-height: 120px;
                padding: 8px 0;
                line-height: 1.4;
                font-family: inherit;
            }
            .macos-chat-${uniqueId} .chat-input::placeholder { color: #666; }

            .macos-chat-${uniqueId} .send-btn {
                background: #0A84FF;
                border: none;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                color: white;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
                flex-shrink: 0;
            }
            .macos-chat-${uniqueId} .send-btn:hover:not(:disabled) { background: #0077ED; transform: scale(1.05); }
            .macos-chat-${uniqueId} .send-btn:disabled { background: #333; color: #555; cursor: not-allowed; }

            .macos-chat-${uniqueId} .hint-text {
                text-align: center; font-size: 11px; color: #444; margin-top: 10px;
            }

            /* --- MARKDOWN STYLES (Cho Bot) --- */
            .macos-chat-${uniqueId} .message-bubble.bot p { margin: 0 0 8px 0; }
            .macos-chat-${uniqueId} .message-bubble.bot p:last-child { margin: 0; }
            .macos-chat-${uniqueId} .message-bubble.bot strong { color: #fff; font-weight: 600; }
            .macos-chat-${uniqueId} .message-bubble.bot ul, .macos-chat-${uniqueId} .message-bubble.bot ol { margin: 8px 0; padding-left: 20px; }
            .macos-chat-${uniqueId} .message-bubble.bot li { margin-bottom: 4px; }
            .macos-chat-${uniqueId} .message-bubble.bot code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 13px; color: #ff9f0a; }
            .macos-chat-${uniqueId} .message-bubble.bot pre { background: #1c1c1e; padding: 12px; border-radius: 8px; overflow-x: auto; margin: 10px 0; border: 1px solid #333; }
            .macos-chat-${uniqueId} .message-bubble.bot pre code { background: none; padding: 0; color: #e5e5e5; }
        </style>
    `;

    // --- 3. HTML STRUCTURE ---
    const chatHTML = `
        <div class="macos-chat-${uniqueId}">
            <div class="chat-sidebar">
                <div class="sidebar-header">
                    <button class="new-chat-btn" id="btn-new-chat-${uniqueId}">
                        <i class="fas fa-plus"></i>
                        <span>Đoạn chat mới</span>
                    </button>
                </div>
                <div class="chat-history" id="history-list-${uniqueId}">
                    <div class="loading-msg">Đang tải lịch sử...</div>
                </div>
            </div>

            <div class="chat-main">
                <div class="chat-header">
                    <div class="header-left">
                        <div class="bot-avatar-header">AI</div>
                        <div class="bot-info">
                            <h3>Trợ lý Sinh viên</h3>
                            <p>Sẵn sàng hỗ trợ</p>
                        </div>
                    </div>
                    <div style="color: #666; font-size: 12px;" id="status-${uniqueId}"></div>
                </div>

                <div class="messages-container" id="messages-${uniqueId}">
                    <div class="message-wrapper">
                        <div class="message-avatar bot">AI</div>
                        <div class="message-content">
                            <div class="message-bubble bot">
                                Xin chào! Tôi có thể giúp gì cho bạn về quy chế, học bổng hay lịch học không?
                            </div>
                            <div class="message-time">Bây giờ</div>
                        </div>
                    </div>
                </div>

                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea
                            id="chat-input-${uniqueId}"
                            class="chat-input"
                            placeholder="Nhập câu hỏi của bạn..."
                            rows="1"
                        ></textarea>
                        <button id="send-btn-${uniqueId}" class="send-btn" disabled>
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                    <div class="hint-text">Enter để gửi • Shift + Enter xuống dòng</div>
                </div>
            </div>
        </div>
    `;

    // Render vào DOM
    container.html(chatStyles + chatHTML);

    // --- 4. LOGIC JAVASCRIPT ---

    // Elements
    const messagesContainer = $win.find(`#messages-${uniqueId}`);
    const chatInput = $win.find(`#chat-input-${uniqueId}`);
    const sendBtn = $win.find(`#send-btn-${uniqueId}`);
    const historyList = $win.find(`#history-list-${uniqueId}`);
    const newChatBtn = $win.find(`#btn-new-chat-${uniqueId}`);

    // Helper: Cuộn xuống cuối
    const scrollToBottom = () => {
        messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
    };

    // Helper: Format thời gian
    const getCurrentTime = () => new Date().toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'});

    // Helper: Hiển thị Typing Indicator
    const showTyping = () => {
        const html = `
            <div class="message-wrapper typing-wrapper">
                <div class="message-avatar bot">AI</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                    </div>
                </div>
            </div>`;
        messagesContainer.append(html);
        scrollToBottom();
    };

    //
    const removeTyping = () => messagesContainer.find('.typing-wrapper').remove();

    // Helper: Hiển thị tin nhắn
    const appendMessage = (text, sender) => {
        const time = getCurrentTime();
        const avatarText = sender === 'user' ? 'U' : 'AI';
        const avatarClass = sender === 'user' ? 'user' : 'bot';
        const bubbleClass = sender === 'user' ? 'user' : 'bot';

        // Parse Markdown nếu là bot (dùng thư viện marked)
        let content = text;
        if (sender === 'bot' && typeof marked !== 'undefined') {
            content = marked.parse(text);
        } else if (sender === 'bot') {
            // Fallback nếu quên import marked
            content = text.replace(/\n/g, '<br>');
        } else {
            // User input thì escape HTML để tránh XSS
            content = $('<div>').text(text).html().replace(/\n/g, '<br>');
        }

        const html = `
            <div class="message-wrapper ${sender}">
                <div class="message-avatar ${avatarClass}">${avatarText}</div>
                <div class="message-content">
                    <div class="message-bubble ${bubbleClass}">${content}</div>
                    <div class="message-time">${time}</div>
                </div>
            </div>
        `;
        messagesContainer.append(html);
        scrollToBottom();
    };

    // --- LOGIC 1: TẢI LỊCH SỬ CHAT (SIDEBAR) ---
    const loadHistory = async () => {
        if (!currentUserId) {
            historyList.html('<div class="loading-msg">⚠️ Vui lòng đăng nhập<br>ở ứng dụng Tài Khoản.</div>');
            return;
        }

        try {
            // LƯU Ý: Đã dùng /api/...
            const res = await fetch(`/api/chats?userId=${currentUserId}`);
            const chats = await res.json();

            historyList.empty();

            if (chats.length === 0) {
                historyList.html('<div class="loading-msg">Chưa có đoạn chat nào.</div>');
                return;
            }

            chats.forEach(chat => {
                const activeClass = chat.id === currentChatId ? 'active' : '';
                const title = chat.title || 'Đoạn chat mới';
                const date = new Date(chat.created_at).toLocaleDateString('vi-VN', {day:'numeric', month:'numeric'});

                const itemHtml = `
                    <div class="history-item ${activeClass}" data-id="${chat.id}">
                        <i class="fas fa-message" style="margin-top:2px;"></i>
                        <div style="flex:1; min-width:0;">
                            <div class="history-title">${title}</div>
                            <div class="history-time">${date}</div>
                        </div>
                    </div>
                `;
                historyList.append(itemHtml);
            });

            // Gắn sự kiện click
            historyList.find('.history-item').click(function() {
                const chatId = $(this).data('id');
                switchChat(chatId);
            });

        } catch (error) {
            console.error(error);
            historyList.html('<div class="loading-msg">Lỗi tải dữ liệu.</div>');
        }
    };

    // --- LOGIC 2: CHUYỂN ĐOẠN CHAT ---
    const switchChat = async (chatId) => {
        if (currentChatId === chatId) return; // Đang xem rồi thì thôi
        currentChatId = chatId;

        // UI Updates
        historyList.find('.history-item').removeClass('active');
        historyList.find(`[data-id="${chatId}"]`).addClass('active');
        messagesContainer.empty();
        messagesContainer.append('<div class="loading-msg">Đang tải tin nhắn...</div>');

        try {
            const res = await fetch(`/api/messages?chatId=${chatId}`);
            const messages = await res.json();

            messagesContainer.empty(); // Xóa loading

            messages.forEach(msg => {
                const sender = msg.role === 'assistant' ? 'bot' : 'user';
                appendMessage(msg.content, sender);
            });
            scrollToBottom();

        } catch (error) {
            messagesContainer.html('<div class="loading-msg">Lỗi tải tin nhắn.</div>');
        }
    };

    // --- LOGIC 3: GỬI TIN NHẮN (ĐÃ FIX URL) ---
    const handleSend = async () => {
        const question = chatInput.val().trim();
        if (!question) return;

        if (!currentUserId) {
    appendMessage("⚠️ Bạn cần đăng nhập trước. Vui lòng mở ứng dụng Account (biểu tượng văn bản) để đăng nhập.", 'bot');
    return;
}

        // UI Optimistic Update
        appendMessage(question, 'user');
        chatInput.val('').trigger('input'); // Clear input & resize
        sendBtn.prop('disabled', true);
        showTyping();

        try {

            const res = await fetch('/api/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: question,
                    userId: currentUserId,
                    chatId: currentChatId // Gửi kèm ID (nếu null server sẽ tạo mới)
                })
            });

            const data = await res.json();

            removeTyping();

            if (data.answer) {
                appendMessage(data.answer, 'bot');
            }

            // Nếu đây là tin nhắn đầu tiên của đoạn chat mới -> Reload sidebar để hiện title mới
            if (currentChatId === null && data.chatId) {
                currentChatId = data.chatId;
                loadHistory(); // Reload sidebar
            }

        } catch (error) {
            console.error("Lỗi chat:", error);
            removeTyping();
            appendMessage("⚠️ Lỗi kết nối server. Vui lòng thử lại.", 'bot');
        } finally {
            sendBtn.prop('disabled', false);
            chatInput.focus();
        }
    };

    // --- LOGIC 4: TẠO CHAT MỚI ---
    newChatBtn.click(() => {
        currentChatId = null;
        historyList.find('.history-item').removeClass('active');
        messagesContainer.empty();

        // Tin nhắn chào mừng mặc định
        const welcome = `
            <div class="message-wrapper">
                <div class="message-avatar bot">AI</div>
                <div class="message-content">
                    <div class="message-bubble bot">
                        Chào bạn! Chúng ta bắt đầu chủ đề mới nhé.
                    </div>
                    <div class="message-time">${getCurrentTime()}</div>
                </div>
            </div>
        `;
        messagesContainer.append(welcome);
        chatInput.focus();
    });

    // --- EVENT LISTENERS ---

    // Gửi khi bấm nút
    sendBtn.click(handleSend);

    // Gửi khi bấm Enter (Shift+Enter để xuống dòng)
    chatInput.on('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    });

    // Auto-resize input
    chatInput.on('input', function() {
        const val = $(this).val();
        // Enable/Disable nút gửi
        sendBtn.prop('disabled', val.trim().length === 0);

        // Resize height
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    // --- KHỞI CHẠY ---
    loadHistory(); // Load sidebar ngay khi mở app
    chatInput.focus();
}


    // 3. login / account management
    function renderTextEdit(container, id, $win) {
    const uniqueId = $win.attr('id');

    // 1. CSS Styles (Giữ nguyên style đẹp của bạn)
    const styles = `
    <style>
        .auth-container-${uniqueId} {
            width: 100%; height: 100%; background: #f5f5f7;
            display: flex; align-items: center; justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow-y: auto;
        }
        .auth-card {
            background: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 90%; max-width: 320px; text-align: center;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .auth-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; color: #1d1d1f; }
        .auth-input {
            width: 100%; padding: 10px 12px; margin-bottom: 12px;
            border: 1px solid #d2d2d7; border-radius: 8px; font-size: 14px;
            box-sizing: border-box; outline: none;
        }
        .auth-input:focus { border-color: #0071e3; box-shadow: 0 0 0 3px rgba(0,113,227,0.1); }

        .auth-btn {
            width: 100%; padding: 10px; background: #0071e3; color: white;
            border: none; border-radius: 8px; font-size: 14px; font-weight: 600;
            cursor: pointer; transition: background 0.2s;
        }
        .auth-btn:hover { background: #0077ed; }
        .auth-btn:disabled { background: #ccc; cursor: not-allowed; }

        .auth-btn.secondary { background: transparent; color: #0071e3; margin-top: 10px; font-weight: normal; }
        .auth-btn.secondary:hover { background: #e8e8ed; text-decoration: underline; }

        .auth-links { display: flex; justify-content: space-between; margin-top: 15px; font-size: 12px; }
        .auth-link { color: #666; cursor: pointer; text-decoration: none; }
        .auth-link:hover { color: #0071e3; }

        .hidden { display: none !important; }
        .error-msg { color: #ff3b30; font-size: 13px; margin-bottom: 10px; text-align: left; display: none; }
        .success-msg { color: #28cd41; font-size: 13px; margin-bottom: 10px; text-align: center; display: none; }
    </style>
    `;

    // 2. HTML Structure
    const html = `
    <div class="auth-container-${uniqueId}">

        <!-- VIEW: LOGIN -->
        <div id="view-login" class="auth-card">
            <div class="auth-title">Đăng Nhập</div>
            <div class="error-msg" id="login-error"></div>

            <input type="email" id="login-email" class="auth-input" placeholder="Email (@tnut.edu.vn)">
            <input type="password" id="login-pass" class="auth-input" placeholder="Mật khẩu">

            <button class="auth-btn" id="btn-login">Đăng nhập</button>

            <div class="auth-links">
                <a class="auth-link" id="link-forgot">Quên mật khẩu?</a>
                <a class="auth-link" id="link-register">Đăng ký mới</a>
            </div>
        </div>

        <!-- VIEW: REGISTER -->
        <div id="view-register" class="auth-card hidden">
            <div class="auth-title">Tạo Tài Khoản</div>
            <div class="error-msg" id="reg-error"></div>
            <div class="success-msg" id="reg-success"></div>

            <!-- Bước 1: Nhập info -->
            <div id="reg-step-1">
                <input type="email" id="reg-email" class="auth-input" placeholder="Email của bạn">
                <input type="password" id="reg-pass" class="auth-input" placeholder="Tạo mật khẩu">
                <button class="auth-btn" id="btn-send-otp-reg">Gửi mã OTP</button>
            </div>

            <!-- Bước 2: Nhập OTP -->
            <div id="reg-step-2" class="hidden">
                <p style="font-size:12px; color:#666; margin-bottom:10px;">
                    Đã gửi OTP đến <b id="reg-email-display"></b>
                </p>
                <input type="text" id="reg-otp" class="auth-input" placeholder="Nhập mã 6 số trong email">
                <button class="auth-btn" id="btn-verify-reg">Xác thực & Đăng ký</button>
                <button class="auth-btn secondary" id="btn-resend-reg" style="font-size:12px;">Gửi lại mã</button>
            </div>

            <button class="auth-btn secondary" id="back-to-login-1">Quay lại đăng nhập</button>
        </div>

        <!-- VIEW: FORGOT PASSWORD -->
        <div id="view-forgot" class="auth-card hidden">
            <div class="auth-title">Quên Mật Khẩu</div>
            <div class="error-msg" id="forgot-error"></div>
            <div class="success-msg" id="forgot-success"></div>

            <div id="forgot-step-1">
                <p style="font-size:12px; color:#666; margin-bottom:10px;">Nhập email để nhận mã khôi phục.</p>
                <input type="email" id="forgot-email" class="auth-input" placeholder="Email tài khoản">
                <button class="auth-btn" id="btn-send-otp-forgot">Gửi mã xác nhận</button>
            </div>

            <div id="forgot-step-2" class="hidden">
                <input type="text" id="forgot-otp" class="auth-input" placeholder="Nhập mã OTP trong email">
                <input type="password" id="new-pass" class="auth-input" placeholder="Mật khẩu mới">
                <button class="auth-btn" id="btn-reset-pass">Đổi mật khẩu</button>
            </div>

            <button class="auth-btn secondary" id="back-to-login-2">Quay lại</button>
        </div>
    </div>
    `;

    // 3. RENDER
    container.html(styles + html);

    // 4. LOGIC
    const viewLogin = container.find('#view-login');
    const viewReg = container.find('#view-register');
    const viewForgot = container.find('#view-forgot');

    // -- Helper reset forms --
    function resetForms() {
        container.find('.error-msg, .success-msg').hide().text('');
        container.find('input').val('');
        container.find('.auth-btn').prop('disabled', false).text(function() { return $(this).attr('original-text') || $(this).text(); });
    }
    // Lưu text gốc của nút để restore sau khi loading
    container.find('.auth-btn').each(function() { $(this).attr('original-text', $(this).text()); });


    // -- CHUYỂN VIEW --
    container.find('#link-register').click(() => {
        resetForms();
        viewLogin.addClass('hidden');
        viewReg.removeClass('hidden');
    });
    container.find('#link-forgot').click(() => {
        resetForms();
        viewLogin.addClass('hidden');
        viewForgot.removeClass('hidden');
    });
    container.find('#back-to-login-1, #back-to-login-2').click(() => {
        resetForms();
        viewReg.addClass('hidden');
        viewForgot.addClass('hidden');
        viewLogin.removeClass('hidden');
        // Reset steps logic
        container.find('#reg-step-1').removeClass('hidden');
        container.find('#reg-step-2').addClass('hidden');
        container.find('#forgot-step-1').removeClass('hidden');
        container.find('#forgot-step-2').addClass('hidden');
    });

    // ==========================================
    // A. ĐĂNG NHẬP (LOGIN)
    // ==========================================
    container.find('#btn-login').click(async function() {
        const btn = $(this);
        const email = container.find('#login-email').val().trim();
        const password = container.find('#login-pass').val().trim();
        const errorBox = container.find('#login-error');

        if(!email || !password) return errorBox.text("Vui lòng điền đầy đủ thông tin").show();

        btn.text('Đang kiểm tra...').prop('disabled', true);
        errorBox.hide();

        try {
            // GỌI API LOGIN THẬT
            const res = await fetch('/api/login', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();

            if (data.success) {
                localStorage.setItem('userId', data.userId);
                localStorage.setItem('userEmail', email);

                btn.text('Thành công!').css('background', '#28cd41');

                // Đóng cửa sổ Login sau 1s
                setTimeout(() => {
                    $win.remove();
                    updateAppleMenuState(); // Cập nhật Apple menu
                    // Optional: Auto open chatbot
                    wm.openApp('chatbot');
                }, 800);
            } else {
                errorBox.text(data.message || 'Email hoặc mật khẩu sai').show();
                btn.text('Đăng nhập').prop('disabled', false);
            }
        } catch (e) {
            console.error(e);
            errorBox.text('Không thể kết nối Server').show();
            btn.text('Đăng nhập').prop('disabled', false);
        }
    });

    // ==========================================
    // B. ĐĂNG KÝ (REGISTER)
    // ==========================================

    // B1. GỬI OTP ĐĂNG KÝ (ĐÃ FIX: DÙNG API THẬT)
    container.find('#btn-send-otp-reg, #btn-resend-reg').click(async function() {
        const btn = $(this);
        const email = container.find('#reg-email').val().trim();
        const pass = container.find('#reg-pass').val().trim();
        const errorBox = container.find('#reg-error');
        const successBox = container.find('#reg-success');

        if(!email || !pass) return errorBox.text("Vui lòng nhập Email và Mật khẩu").show();

        btn.text('Đang gửi OTP...').prop('disabled', true);
        errorBox.hide(); successBox.hide();

        try {
            // GỌI API GỬI OTP
            const res = await fetch('/api/send-otp', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: email, type: 'register' }) // type: register
            });
            const data = await res.json();

            if (data.success) {
                container.find('#reg-email-display').text(email);
                container.find('#reg-step-1').addClass('hidden');
                container.find('#reg-step-2').removeClass('hidden');
                successBox.text('Đã gửi mã OTP! Kiểm tra cả mục Spam.').show();
            } else {
                errorBox.text(data.message || 'Lỗi gửi mail').show();
                btn.text('Gửi mã OTP').prop('disabled', false);
            }
        } catch (e) {
            errorBox.text('Lỗi kết nối Server').show();
            btn.text('Gửi mã OTP').prop('disabled', false);
        }
    });

    // B2. XÁC THỰC VÀ TẠO TÀI KHOẢN
    container.find('#btn-verify-reg').click(async function() {
        const btn = $(this);
        const email = container.find('#reg-email').val().trim();
        const password = container.find('#reg-pass').val().trim();
        const otp = container.find('#reg-otp').val().trim();
        const errorBox = container.find('#reg-error');

        if(!otp) return errorBox.text("Vui lòng nhập OTP").show();

        btn.text('Đang xác thực...').prop('disabled', true);

        try {
            const res = await fetch('/api/register', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email, password, otp })
            });
            const data = await res.json();

            if(data.success) {
    const successBox = container.find('#reg-success');
    successBox.text('✅ Đăng ký thành công! Đang chuyển về đăng nhập...').show();

    setTimeout(() => {
        container.find('#back-to-login-1').click(); // Quay về login
    }, 1500);
} else {
                errorBox.text(data.message || 'Mã OTP không đúng').show();
                btn.text('Xác thực & Đăng ký').prop('disabled', false);
            }
        } catch (e) {
            errorBox.text('Lỗi kết nối').show();
            btn.text('Xác thực & Đăng ký').prop('disabled', false);
        }
    });

    // ==========================================
    // C. QUÊN MẬT KHẨU (FORGOT PASSWORD)
    // ==========================================

    // C1. Gửi OTP quên mật khẩu
    container.find('#btn-send-otp-forgot').click(async function() {
        const btn = $(this);
        const email = container.find('#forgot-email').val().trim();
        const errorBox = container.find('#forgot-error');

        if(!email) return errorBox.text("Vui lòng nhập Email").show();

        btn.text('Đang gửi...').prop('disabled', true);
        errorBox.hide();

        try {
            // Gọi API gửi OTP với type = 'forgot' (Nếu server hỗ trợ)
            // Hoặc dùng tạm type='register' nếu logic server chưa phân biệt
            const res = await fetch('/api/send-otp', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email, type: 'forgot' })
            });
            const data = await res.json();

            if (data.success) {
                container.find('#forgot-step-1').addClass('hidden');
                container.find('#forgot-step-2').removeClass('hidden');
            } else {
                errorBox.text(data.message).show();
                btn.text('Gửi mã').prop('disabled', false);
            }
        } catch (e) {
            errorBox.text('Lỗi kết nối').show();
            btn.text('Gửi mã').prop('disabled', false);
        }
    });

    // C2. Đổi mật khẩu mới
    container.find('#btn-reset-pass').click(async function() {
        const btn = $(this);
        const email = container.find('#forgot-email').val().trim();
        const otp = container.find('#forgot-otp').val().trim();
        const newPass = container.find('#new-pass').val().trim();
        const errorBox = container.find('#forgot-error');

        if(!otp || !newPass) return errorBox.text("Vui lòng nhập đủ thông tin").show();

        btn.text('Đang đổi...').prop('disabled', true);

        try {
            // LƯU Ý: Bạn cần tạo thêm API /api/reset-password ở server.js
            // Nếu chưa có, đoạn này sẽ lỗi 404
            const res = await fetch('/api/reset-password', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email, otp, newPassword: newPass })
            });
            const data = await res.json();

            if(data.success) {
    const successBox = container.find('#forgot-success');
    successBox.text('✅ Đổi mật khẩu thành công! Đang chuyển về đăng nhập...').show();

    setTimeout(() => {
        container.find('#back-to-login-2').click();
    }, 1500);
} else {
                errorBox.text(data.message || 'OTP sai hoặc hết hạn').show();
                btn.text('Đổi mật khẩu').prop('disabled', false);
            }
        } catch (e) {
            errorBox.text('Chưa có API đổi mật khẩu').show();
            btn.text('Đổi mật khẩu').prop('disabled', false);
        }
    });
}



    // 4. SKETCH (Paint)
    let canvas, ctx, painting = false;
    function renderPaint(container) {
        container.html(`
            <div class="paint-app">
                <div class="paint-toolbar">
                    <input type="color" id="p-color" value="#000000">
                    <input type="range" id="p-size" min="1" max="50" value="5" title="Brush Size">
                    <button class="text-tool" onclick="clearCanvas()"><i class="fas fa-trash"></i> Clear</button>
                    <button class="text-tool" id="p-eraser"><i class="fas fa-eraser"></i></button>
                </div>
                <div style="flex:1; overflow:hidden; position:relative;">
                    <canvas id="paint-canvas"></canvas>
                </div>
            </div>
        `);

        setTimeout(initCanvas, 100); // Wait for DOM
    }

    function initCanvas() {
        canvas = document.getElementById('paint-canvas');
        if(!canvas) return;
        ctx = canvas.getContext('2d');
        resizeCanvas();

        let color = '#000000';
        let size = 5;
        let mode = 'draw';

        $('#p-color').on('change', function() { color = this.value; mode='draw'; });
        $('#p-size').on('input', function() { size = this.value; });
        $('#p-eraser').on('click', function() { mode = 'erase'; });

        function startPosition(e) {
            painting = true;
            draw(e);
        }
        function finishedPosition() {
            painting = false;
            ctx.beginPath();
        }
        function draw(e) {
            if (!painting) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineWidth = size;
            ctx.lineCap = 'round';
            ctx.strokeStyle = mode === 'erase' ? '#ffffff' : color;

            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', finishedPosition);
        canvas.addEventListener('mousemove', draw);
    }

    window.resizeCanvas = function() {
        if(!canvas) return;
        const parent = canvas.parentElement;
        // Save img data
        const imgData = ctx.getImageData(0,0,canvas.width, canvas.height);
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;
        // Fill white background
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.putImageData(imgData, 0,0);
    }
    window.clearCanvas = function() {
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // 5. CALCULATOR
    function renderCalculator(container) {
        container.html(`
            <div class="calc-app">
                <input type="text" id="calc-display" value="0" readonly>
                <div class="calc-grid">
                    <button class="calc-btn c-top" onclick="calcClear()">AC</button>
                    <button class="calc-btn c-top">+/-</button>
                    <button class="calc-btn c-top">%</button>
                    <button class="calc-btn c-op" onclick="calcOp('/')">÷</button>
                    <button class="calc-btn c-num" onclick="calcNum(7)">7</button>
                    <button class="calc-btn c-num" onclick="calcNum(8)">8</button>
                    <button class="calc-btn c-num" onclick="calcNum(9)">9</button>
                    <button class="calc-btn c-op" onclick="calcOp('*')">×</button>
                    <button class="calc-btn c-num" onclick="calcNum(4)">4</button>
                    <button class="calc-btn c-num" onclick="calcNum(5)">5</button>
                    <button class="calc-btn c-num" onclick="calcNum(6)">6</button>
                    <button class="calc-btn c-op" onclick="calcOp('-')">−</button>
                    <button class="calc-btn c-num" onclick="calcNum(1)">1</button>
                    <button class="calc-btn c-num" onclick="calcNum(2)">2</button>
                    <button class="calc-btn c-num" onclick="calcNum(3)">3</button>
                    <button class="calc-btn c-op" onclick="calcOp('+')">+</button>
                    <button class="calc-btn c-num c-zero" onclick="calcNum(0)">0</button>
                    <button class="calc-btn c-num">.</button>
                    <button class="calc-btn c-op" onclick="calcEq()">=</button>
                </div>
            </div>
        `);
    }

    let calcCur = '0', calcPrev = null, calcOper = null, newNum = true;
    const updateDisp = () => $('#calc-display').val(calcCur);
    window.calcNum = (num) => {
        if(newNum) { calcCur = num.toString(); newNum = false; } else { calcCur = calcCur === '0' ? num.toString() : calcCur + num; }
        updateDisp();
    };
    window.calcOp = (op) => { calcPrev = parseFloat(calcCur); calcOper = op; newNum = true; };
    window.calcClear = () => { calcCur='0'; calcPrev=null; calcOper=null; newNum=true; updateDisp(); };
    window.calcEq = () => {
        if(calcOper && !newNum) {
            const cur = parseFloat(calcCur);
            switch(calcOper){
                case '+': calcCur = calcPrev + cur; break;
                case '-': calcCur = calcPrev - cur; break;
                case '*': calcCur = calcPrev * cur; break;
                case '/': calcCur = calcPrev / cur; break;
            }
            calcOper = null; newNum = true; updateDisp();
        }
    };

    // 6. SAFARI
    function renderSafari(container) {
        container.html(`
            <div class="safari-app">
                <div class="safari-bar">
                    <i class="fas fa-chevron-left" style="color:#888;"></i>
                    <i class="fas fa-chevron-right" style="color:#888;"></i>
                    <i class="fas fa-redo" style="color:#555; font-size:12px;"></i>
                    <input type="text" class="url-bar" value="en.wikipedia.org/wiki/MacOS" id="safari-url">
                    <i class="fas fa-share-square" style="color:#555;"></i>
                </div>
                <iframe src="https://en.wikipedia.org/wiki/MacOS"class="safari-frame" id="safari-frame" sandbox="allow-scripts allow-same-origin"></iframe>
            </div>
        `);
        $('#safari-url').on('keypress', function(e) {
            if(e.which == 13) {
                let url = this.value;
                if(!url.startsWith('http')) url = 'https://' + url;
                $('#safari-frame').attr('src', url);
            }
        });
    }

    // 7. STUDIO (Video Editor sim)
// 7. STUDIO (Image Slideshow - responsive & dock-safe)
function renderStudio(container) {
    const slides = [
        'https://picsum.photos/1600/900?image=1050',
        'https://picsum.photos/1600/900?image=1025',
        'https://picsum.photos/1600/900?image=1031',
        'https://picsum.photos/1600/900?image=1035'
    ];
    let current = 0;

    container.html(`
        <div class="studio-app" style="display:flex; flex-direction:column; height:100%;">
            <div class="video-stage"
                 style="flex:1; display:flex; justify-content:center; align-items:center; background:#000;">
                <img id="slide-img" src="${slides[current]}"
                     style="width:100%; height:100%; object-fit:contain; border-radius:8px; transition:0.3s;">
            </div>
            <div class="studio-controls"
                 style="background:#1a1a1a; padding:10px; display:flex; flex-direction:column; gap:5px;
                        border-top:1px solid rgba(255,255,255,0.1); position:relative; z-index:5;">
                <div class="filters-row" id="slide-thumbs"
                     style="display:flex; justify-content:center; flex-wrap:wrap; gap:6px;"></div>
                <div class="playback-row"
                     style="display:flex; justify-content:center; align-items:center; gap:15px; color:#ddd; padding-bottom:4px;">
                    <i class="fas fa-backward" id="prev-slide" style="cursor:pointer;"></i>
                    <i class="fas fa-play" id="play-slides"
                       style="font-size:20px; color:white; cursor:pointer;"></i>
                    <i class="fas fa-forward" id="next-slide" style="cursor:pointer;"></i>
                </div>
            </div>
        </div>
    `);

    // Tạo thumbnail
    slides.forEach((src, i) => {
        $('#slide-thumbs').append(`
            <img src="${src}" class="thumb" data-i="${i}"
                 style="width:70px; height:45px; object-fit:cover; border-radius:4px;
                        cursor:pointer; opacity:${i===0?1:0.5};
                        border:${i===0?'2px solid var(--accent)':'2px solid transparent'};
                        transition:all 0.2s;">
        `);
    });

    // Chọn slide
    $('#slide-thumbs').on('click', '.thumb', function(){
        current = $(this).data('i');
        updateSlide();
    });

    // Điều khiển
    $('#next-slide').on('click', () => { current = (current + 1) % slides.length; updateSlide(); });
    $('#prev-slide').on('click', () => { current = (current - 1 + slides.length) % slides.length; updateSlide(); });

    // Tự động trình chiếu
    let playing = false, timer = null;
    $('#play-slides').on('click', function() {
        playing = !playing;
        $(this).toggleClass('fa-play fa-pause');
        if (playing) timer = setInterval(() => $('#next-slide').click(), 3000);
        else clearInterval(timer);
    });

    function updateSlide(){
        $('#slide-img').attr('src', slides[current]);
        $('.thumb').css({opacity:0.5, border:'2px solid transparent'})
                   .eq(current).css({opacity:1, border:'2px solid var(--accent)'});
    }

    // Đảm bảo ảnh scale theo kích thước cửa sổ (khi maximize hoặc resize)
    const win = container.closest('.window');
    const adjustSize = () => {
        const stage = win.find('.video-stage');
        stage.find('#slide-img').css({
            width: stage.width() + 'px',
            height: stage.height() + 'px'
        });
    };
    $(window).on('resize', adjustSize);
    new ResizeObserver(adjustSize).observe(win[0]);
}



    // 8. SETTINGS
    function renderSettings(container) {
        container.html(`
            <div class="settings-app">
                <div style="display:flex; align-items:center; gap:15px; width:100%; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
                    <div style="width:60px; height:60px; background:#ccc; border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:30px; color:#555;"><i class="fas fa-user"></i></div>
                    <div><div style="font-weight:600; font-size:16px;">Guest User</div><div style="font-size:12px; color:#aaa;">Apple ID, iCloud, Media & App Store</div></div>
                </div>
                <div style="align-self:flex-start; font-weight:600;">Wallpaper</div>
                <div class="wall-grid">
                    <div class="wall-thumb selected" style="background: linear-gradient(200deg, #a729f5, #5823d6, #092775, #1d6f9c);" onclick="changeWall(this)"></div>
                    <div class="wall-thumb" style="background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);" onclick="changeWall(this)"></div>
                    <div class="wall-thumb" style="background: url('https://source.unsplash.com/random/800x600?nature,mountain'); background-size:cover;" onclick="changeWall(this)"><span>Ext (Unsplash)</span></div>
                    <div class="wall-thumb" style="background: #000;" onclick="changeWall(this)"></div>
                </div>
            </div>
        `);
    }
    window.changeWall = function(el) {
        $('.wall-thumb').removeClass('selected');
        $(el).addClass('selected');
        $('body').css('background', $(el).css('background'));
    }

    // --- Infrastructure ---

    // Clock
    function updateClock() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        $('#clock').text(`${dateStr} ${timeStr}`);
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Battery (if supported)
    if ('getBattery' in navigator) {
        navigator.getBattery().then(battery => {
            $('#battery-level').text(Math.round(battery.level * 100) + '%');
        });
    }

    /// Boot Sequence
    $(window).on('load', () => {
        $('.loading-progress').css('width', '100%');
        setTimeout(() => {
            $('#boot-screen').fadeOut(500, function(){ $(this).remove(); });

            // Check login state - open Login if not logged in, else open Finder
            const userId = localStorage.getItem('userId');
            if (!userId) {
                setTimeout(() => wm.openApp('login'), 600);
            } else {
                setTimeout(() => wm.openApp('finder'), 600);
            }
        }, 3200);
    });

    // --- Apple Menu Logic ---
    let appleMenuOpen = false;

// Apple Menu Item Click Handlers
$('#menu-login-btn').on('click', function(e) {
    e.stopPropagation();
    $('#apple-menu').hide();
    wm.openApp('login');
});

$('#menu-logout-btn').on('click', function(e) {
    e.stopPropagation();
    handleLogout();
});

$('#menu-settings-btn').on('click', function(e) {
    e.stopPropagation();
    $('#apple-menu').hide();
    wm.openApp('settings');
});

// Toggle Apple Menu
$('.apple-menu-trigger').on('click', function(e) {
    e.stopPropagation();

    const menu = $('#apple-menu');
    const isVisible = menu.is(':visible');

    if (isVisible) {
        menu.hide();
    } else {
        menu.show();
        updateAppleMenuState();
    }
});
    // Close menu when click outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#apple-menu, .apple-menu-trigger').length) {
            $('#apple-menu').hide();
            appleMenuOpen = false;
        }
    });

    // Update menu based on login state
    function updateAppleMenuState() {
    const userId = localStorage.getItem('userId');
    const userEmail = localStorage.getItem('userEmail');

    if (userId) {
        $('#menu-guest').hide();
        $('#menu-logged').show();
        $('#menu-user-email').text(userEmail || 'User');
    } else {
        $('#menu-guest').show();
        $('#menu-logged').hide();
    }
}

// Logout handler
    window.handleLogout = function() {
    // Đăng xuất
    localStorage.removeItem('userId');
    localStorage.removeItem('userEmail');

    // Đóng tất cả cửa sổ Chatbot và Login
    if (wm.windows['chatbot']) {
        wm.closeWindow('chatbot');
    }
    if (wm.windows['login']) {
        wm.closeWindow('login');
    }

    // Ẩn Apple Menu
    $('#apple-menu').hide();

    // Cập nhật trạng thái menu
    updateAppleMenuState();

    // Hiển thị toast
    showToast('✓ Đã đăng xuất');

    // Tự động mở Login sau 1 giây
    setTimeout(() => {
        wm.openApp('login');
    }, 1000);
};

function showToast(message) {
    const toast = $('<div>')
        .text(message) // ✅ Dùng .text() thay vì template literal
        .css({
            position: 'fixed',
            bottom: '80px',
            left: '50%',
            transform: 'translateX(-50%)',
            background: 'rgba(0,0,0,0.85)',
            color: 'white',
            padding: '12px 24px',
            borderRadius: '20px',
            fontSize: '13px',
            zIndex: 99999,
            backdropFilter: 'blur(10px)',
            boxShadow: '0 4px 15px rgba(0,0,0,0.3)',
            opacity: 0,
            transition: 'opacity 0.3s ease'
        });

    $('body').append(toast);

    // Fade in
    setTimeout(() => toast.css('opacity', 1), 10);

    // Fade out after 2.5s
    setTimeout(() => {
        toast.css('opacity', 0);
        setTimeout(() => toast.remove(), 300);
    }, 2500);
}updateAppleMenuState();
</script>
</body>
</html>


